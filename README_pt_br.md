## LES: Linux privilege escalation auditing tool

Baixando:

```bash
wget https://raw.githubusercontent.com/mzet-/linux-exploit-suggester/master/linux-exploit-suggester.sh -O les.sh
```

Detalhes sobre o uso e funcionamento do LES.

https://mzet-.github.io/2019/05/10/les-paper.html

Recursos adicionais para o LES:

https://github.com/mzet-/les-res

## Propósito

Desenvolvido para dar assistência na detecção das falhas de segurança em máquinas
que fazem o uso do kernel Linux e/ou derivados do GNU/Linux. Essa ferramenta provê
as seguintes funcionalidades:

### Avaliando as falhas de kernel através de vulnerabilidades conhecidas

A ferramenta acessa as vulnerabilidades conhecidas em domínios públicos, utilizando métodos
heurísticos, discutido em detalhes [neste link](https://mzet-.github.io/2019/05/10/les-paper.html).
Exemplo de saída da ferramenta:

```bash
$ ./linux-exploit-suggester.sh
```

```
...
[+] [CVE-2017-16995] eBPF_verifier

   Details: https://ricklarabee.blogspot.com/2018/07/ebpf-and-analysis-of-get-rekt-linux.html
   Exposure: highly probable
   Tags: debian=9.0{kernel:4.9.0-3-amd64},fedora=25|26|27,[ ubuntu=14.04 ]{kernel:4.4.0-89-generic},ubuntu=(16.04|17.04){kernel:4.(8|10).0-(19|28|45)-generic}
   Download URL: https://www.exploit-db.com/download/45010
   Comments: CONFIG_BPF_SYSCALL needs to be set && kernel.unprivileged_bpf_disabled != 1

[+] [CVE-2017-1000112] NETIF_F_UFO

   Details: http://www.openwall.com/lists/oss-security/2017/08/13/1
   Exposure: probable
   Tags: [ ubuntu=14.04{kernel:4.4.0-*} ],ubuntu=16.04{kernel:4.8.0-*}
   Download URL: https://raw.githubusercontent.com/xairy/kernel-exploits/master/CVE-2017-1000112/poc.c
   ext-url: https://raw.githubusercontent.com/bcoles/kernel-exploits/cve-2017-1000112/CVE-2017-1000112/poc.c
   Comments: CAP_NET_ADMIN cap or CONFIG_USER_NS=y needed. SMEP/KASLR bypass included. Modified version at 'ext-url' adds support for additional distros/kernels

[+] [CVE-2016-8655] chocobo_root

   Details: http://www.openwall.com/lists/oss-security/2016/12/06/1
   Exposure: probable
   Tags: [ ubuntu=(14.04|16.04){kernel:4.4.0-(21|22|24|28|31|34|36|38|42|43|45|47|51)-generic} ]
   Download URL: https://www.exploit-db.com/download/40871
   Comments: CAP_NET_RAW capability is needed OR CONFIG_USER_NS=y needs to be enabled
...
```

Para cada vulnerabilidade, é calculado o nível de criticidade. Os possíveis "níveis
de criticidade" são:

- **Altamente Provável** - o kernel tem maior probabilidade de ser afetado e há
uma grande chance da PoC(Prova de Conceito) funcionar sem muita modificação.

- **Provável** - é possível que a vulnerabilidade funcione, mas deverá ser feito
algumas modificações na PoC para funcionar no seu alvo.

- **Pouco Provável** - vai ser necessário uma análise manual para saber se o kernel
em questão é afetado.

- **Improvável** - altamente improvável que o kernel seja afetado (a vulnerabilidade
não é mostrada na saída da ferramenta)

### Verificando as medidas de segurança no kernel

O LES pode procurar pela maioria das configurações de segurança disponíveis em seu
kernel. Ele não verifica apenas as configurações de "compilação" (os CONFIGs), mas
também verifica configurações em *run-time* (sysctl), provendo uma maior visão
da segurança do kernel que está sendo executado. Essa funcionalidade é uma continuação
moderna do parâmetro `--kernel` do [checksec.sh](http://www.trapkit.de/tools/checksec.html),
ferramenta do Tobias Klein. Exemplo de saída:

```bash
$ ./linux-exploit-suggester.sh --checksec
```

```
Mainline kernel protection mechanisms:

 [ Disabled ] GCC stack protector support (CONFIG_HAVE_STACKPROTECTOR)
              https://github.com/mzet-/les-res/blob/master/features/stackprotector-regular.md

 [ Disabled ] GCC stack protector STRONG support (CONFIG_STACKPROTECTOR_STRONG)
              https://github.com/mzet-/les-res/blob/master/features/stackprotector-strong.md

 [ Enabled  ] Low address space to protect from user allocation (CONFIG_DEFAULT_MMAP_MIN_ADDR)
              https://github.com/mzet-/les-res/blob/master/features/mmap_min_addr.md

 [ Disabled ] Restrict unprivileged access to kernel syslog (CONFIG_SECURITY_DMESG_RESTRICT)
              https://github.com/mzet-/les-res/blob/master/features/dmesg_restrict.md

 [ Enabled  ] Randomize the address of the kernel image (KASLR) (CONFIG_RANDOMIZE_BASE)
              https://github.com/mzet-/les-res/blob/master/features/kaslr.md

 [ Disabled ] Hardened user copy support (CONFIG_HARDENED_USERCOPY)
              https://github.com/mzet-/les-res/blob/master/features/hardened_usercopy.md

...
```

## Utilização

Descobrindo falhas do kernel em questão, as falhas são públicas.

```bash
$ ./linux-exploit-suggester.sh
```

Mostra o estado dos recursos de segurança do GNU/Linux:

```
$ ./linux-exploit-suggester.sh --checksec
```

Acessa as falhas baseando-se no argumento de `--uname` (que é a saída
do comando `uname -a`):

```bash
$ ./linux-exploit-suggester.sh --uname <uname-string>
```

Para mais exemplos, veja este texto:
[link](https://mzet-.github.io/2019/05/10/les-paper.html).

## Envolvendo-se

Agora que você sabe o que o LES é e oque ele pode fazer por você. Agora veja oque
você pode fazer pro LES:

- Adicionar novas formas de escalação de privilégios no GNU/Linux, métodos providos em PoCs.

- Testar vulnerabilidades em várias distribuições GNU/Linux com múltiplas versões de kernel,
documente seus achados em formato de `tags` no LES, um exemplo de `tags` seria:
`ubuntu=12.04{kernel:3.(2|5).0-(23|29)-generic}` que significa:
*a vulnerabilidade foi verificada e funciona corretamente no Ubuntu 12.04 com os kernels:*
*3.2.0-23-generic, 3.2.0-29-generic, 3.5.0-23-generic e 3.5.0-29-generic;*.
Com essa tag adicionada, o LES vai automaticamente destacar e fazer um `Rank` dinâmico da
vulnerabilidade quando "rodar" em sistemas Ubuntu 12.04 com algum dos kernels listados.
Isso pode ajudar você (e outros) durante o *pentest* a rapidamente identificar vulnerabilidades
críticas em máquinas GNU/Linux.

- Vulnerabilidades publicadas geralmente são escritas PoCs, mas que funcionam
apenas em uma (ou algumas) máquinas específicas que utilizam uma determinada versão de kernel ou
distribuição. Pegar o código-fonte do *exploit* e customizar isso para uma versão diferente.
Então adicione o seu *exploit* customizado como `ext-url` no LES e modifique as `Tags` para gerar
novos alvos possíveis. Veja [esse artigo](https://ricklarabee.blogspot.com/2017/12/adapting-poc-for-cve-2017-1000112-to.html),
ele é um bom exemplo de como adaptar uma PoC para uma versão diferente de kernel.

- Conduzir uma análise de código do aprimoramento de segurança do kernel e adiciona isso no *array* `FEATURES`
(se não existir outro parecido) e publica sua análise em: `https://github.com/mzet-/les-res/blob/master/features/<feature-name>.md`.

### Agradecimentos

[bcoles](https://github.com/bcoles/) pela sua excelente e frequente contribuições
ao LES.
