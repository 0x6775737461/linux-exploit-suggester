
## linux-exploit-suggester

Quick download:

    wget https://raw.githubusercontent.com/mzet-/linux-exploit-suggester/master/linux-exploit-suggester.sh -O les.sh

### Overview

Often during the penetration test engagement the security analyst faces the problem of identifying privilege escalation attack vectors on tested Linux machine(s). One of viable attack vectors is using publicly known Linux exploit to gain `root` privileges on tested machine. However in order to do that the analyst needs to identify the right PoC exploit and then modify it to suit his target. The `linux-exploit-suggester.sh` tool is designed to help with these activities.

### Purpose

The tool is meant to assist the security analyst in his testing for privilege escalation opportunities on Linux machine. It arms the analyst with the list of exploits (currently: **69** Linux kernel exploits and **~30** user space exploits) and relevant facts about them. It's not a vulnerability scanner or automated tool. In most cases it requires substantial vulnerability analysis skills and at least rudimentary Linux kernel exploit development skills.

To support analysis `linux-exploit-suggester.sh` provides following modes of operation:

**"Remote" mode (--kernel or --uname switches)**

In this mode the analyst simply provides kernel version (`--kernel` switch) or `uname -a` command output (`--uname` switch) and receives list of candidate exploits for a given kernel version.

Using this mode one can also check for candidate user space exploits (with `--pkglist-file` switch) if he has access to installed packages listing (output of `dpkg -l/rpm -qa` commands) of examined system.

**"Direct" mode (default run)**

The basic idea behind this mode is the same as previously but additionally in an effort to produce more relevant list of candidate exploits, the tool also performs series of additional checks (like: kernel build settings aka CONFIG_*, sysctl entries and other custom checks) to rule out exploits that for sure won't be applicable due to OS customization. If desired one could skip additional checks with `--skip-more-checks` switch.

By default tool also checks for applicable user space exploits when distribution is one of `Debian, Ubuntu, RHEL/CentOS`. To skip user space exploits checks one can run with `--kernelspace-only` switch.

**"CVE list" mode (--cvelist-file switch)**

In this mode the analyst already posesses partial/full list of CVEs that affects his target kernel and wants to verify if there are any publicly known exploits against this CVEs. Of course efectivness of this mode highly depends on completness of provided CVE list. Such list is usually constructed by manual study and examination of distribution's Changelog for the given kernel version. Alternatively for most popular distros [Oracle's Ksplice Inspector](http://www.ksplice.com/inspector) could be used to speed up this proccess. For example following oneliner worked quite fine for me:

```
$ (uname -s; uname -m; uname -r; uname -v) | curl -s https://api-ksplice.oracle.com/api/1/update-list/ -L -H "Accept: text/text" --data-binary @- | grep CVE | tr ' ' '\n' | grep -o -E 'CVE-[0-9]+-[0-9]+' | sort -r -n | uniq
```

WARNING. By default in addition to comparing CVE IDs, this mode also performs **additional checks** to rule out exploits that won't be applicable due to OS customization (kernel build settings aka CONFIG_*, sysctl entries and other custom settings). So for the best possible results one should run it directly on tested machine or alternatively use `--skip-more-checks` command line switch if running on the target is not possible/not desired.

**"Recon" mode (--recon switch)**

WARNING. This mode is in beta currently.

After identifying the exploit that is applicable for the target kernel (using manual analysis and one of modes described above), the analyst usually faces the problem of determining whether given exploit needs any modifications/tailoring for the given system. The "recon" mode is designed to help just with that - it enumerates target system for various kernel/hardware security measures (KASLR, SMEP, etc.) and known kernel/hardware weaknesses (TSX/RTM, etc.). Armed with this knowledge the analyst can modify/rewrite given public exploit/PoC to suit his target.

Example of script's output:

![Alt text](/../screenshot/screenshot3.png "linux-exploit-suggester.sh output")

### Tips, limitations, caveats

 - Remember that this script is only meant to **assist** the analyst in his auditing activities. It won't do the all work for him!
 - That's the analyst job to determine whether given target at hand isn't patched against generated list of candidate exploits (the script doesn't look at distro patchlevel so obviously it won't do that for you)
 - In addition to manual inspection [Oracle's Ksplice Inspector](http://www.ksplice.com/inspector) could come handy with determining the previous one
 - Selected exploit almost certainly will need some customization to suit your target (at minimum: correct commit_creds/prepare_kernel_cred pointers) so knowledge about kernel exploitation techniques is required

### Usage

**Running directly on tested machine**

Running directly on tested machine is suggested mode of operation for `linux-exploit-suggester.sh` as it additionally (to just comparing kernel versions) performs checks like: examines kernel CONFIG_*, checks sysctl entries or runs custom Bash commands to rule out exploits that are not applicable for a given machine. For example:

 - for `dccp` exploit script checks if kernel was build with `CONFIG_IP_DCCP` support,
 - for `af_packet` exploit script checks if kernel was build with `CONFIG_USER_NS` support and if sysctl entry `kernel.unprivileged_userns_clone` is enabled,
 - for `target_offset` exploit script checks if `ip_tables` modules is loaded (executing `grep -qi ip_tables /proc/modules` command),

and so on. Optionally those additional checks can by skipped by running with `--skip-more-checks` command line switch.

Additionally, in this mode `linux-exploit-suggester.sh` by default also fetches installed packages listing and checks for applicable user space exploits if distribution is one of: `Debian, Ubuntu, RHEL/CentOS`.

Default run on target machine (kernel version, packages versions and additional checks as described above are performed to give the list of possible exploits:

    $ ./linux-exploit-suggester.sh

As previously but only userspace exploits are checked:

    $ ./linux-exploit-suggester.sh --userspace-only

**Running with -k|--uname option**

Running with `-k` option is handy if one wants to quickly examine which exploits could be potentially applicable for given kernel version (this is also compatibility mode with Linux_Exploit_Suggester):

    $ ./linux-exploit-suggester.sh -k 3.1

With `--uname` one provides slightly more information (`uname -a` output from target machine) to `linux-exploit-suggester.sh` and receives slightly specific list of possible exploits (for example also target arch `x86|x86_64` is taken into account when generating exploits list):

    $ ./linux-exploit-suggester.sh --uname "Linux taris 3.16.0-30-generic #40~14.04.1-Ubuntu SMP Thu Jan 15 17:43:14 UTC 2015 x86_64 x86_64 x86_64 GNU/Linux"

Optionally `--pkglist-file <file>` could be provided to `-k` or `--uname` to also check for user space exploits:

    (remote machine) $ dpkg -l > dpkgOutput.txt
    $ ./linux-exploit-suggester.sh --uname "Linux taris 3.16.0-30-generic #40~14.04.1-Ubuntu SMP Thu Jan 15 17:43:14 UTC 2015 x86_64 x86_64 x86_64 GNU/Linux" --pkglist-file dpkgOutput.txt

In terms of generated list of exploits its identical with executing (directly on the given remote machine):

    (remote machine) $ ./linux-exploit-suggester.sh --skip-more-checks

**Examining only userspace exploits**

Sometimes it is handy to examine just package listing (in this case only check for userspace exploits is performed):

    (remote machine) $ dpkg -l > dpkgOutput.txt
    $ ./linux-exploit-suggester.sh --pkglist-file dpkgOutput.txt

**Other usages/options**

Kernel version number is taken from current OS, sources for possible exploits are downloaded to current directory (only kernel space exploits are examined):

    $ ./linux-exploit-suggester.sh --fetch-sources --kernelspace-only

Kernel version number is taken from command line, full details (like: kernel version requirements, comments and URL pointing to announcement/technical details about exploit) about matched exploits are listed:

    $ ./linux-exploit-suggester.sh -k 4.1 --full

Kernel version number is taken from current OS, binaries for applicable exploits are downloaded (if available) to current directory:

    $ ./linux-exploit-suggester.sh --fetch-binaries

Note however that `--fetch-binaries` is not recommended as it downloads binaries from generally not trusted sources and most likely these binaries weren't compiled for your target anyway. It should be used as a kind of last resort option when you're running out of time during your pen testing engagement and there is no compiler available on your target at hand.

### Misc

 - The tool was inspired by the [Linux_Exploit_Suggester](https://github.com/PenturaLabs/Linux_Exploit_Suggester) script
 - It is available in [BlackArch](https://www.blackarch.org/) distribution
 - I'm not responsible for how the tool is used and where it is used
